---
layout: post
title: Android源码REQ&BUG
categories: Android系统开发
description: 工作中的REQ&BUG修改集合。
keywords: Android

---

工作中的REQ&BUG修改集合。

### 使用Message发送空白短信
1. 修改发送界面判断当EditText为空时，发送按钮变为可发送状态。由于GoogleMessage是以Apk形式内置到系统，所以我们使用带有源码的SprdMessage。
首先将Message安装到系统中，然后通过SDKtools的monitor获得发送界面的View。
> vendor/sprd/platform/packages/apps/Messaging
>  .../src/com/android/messaging/ui/conversation/ComposeMessageView.java
>

```Java
//根据注释修改hasMessageText为true
   if (MmsConfig.get(mHost.getConversationSelfSubId()).getFinalSendEmptyMessageFlag() == 0) {        //only send sms with space message body
            if (messageText != null && messageText.length() > 0) {
                hasMessageText = true;
            } else {  //if message body don't include any char(eg. space), can't send it
                //改为true
                hasMessageText = false; 
                // if you want to send sms which message body don't include any char(eg. space), set this line to hasMessageText = true
            } 
```

2. 接着我们看到发送方法

```Java
    private void sendMessageInternal(final boolean checkMessageSize) {
      ...
         if(TextUtils.getTrimmedLength(message.getMessageText()) == 0){
                                    //这里有一个是否允许发送空白Message的Flag，可以添加Log打印发现是0
                                    if((MmsConfig.get(mHost.getConversationSelfSubId()).getFinalSendEmptyMessageFlag() == 1)
                                            || (MmsConfig.get(mHost.getConversationSelfSubId()).getFinalSendEmptyMessageFlag() == 0 && message.getMessageText().length() > 0)) {
                                           confirmSendEmptyMsg(message);
                                           }
       ...                             
    }
```

知道了Flag为0，我们接着去找getFinalSendEmptyMessageFlag()这个方法。
>src/com/android/messaging/sms/MmsConfig.java
>

```Java
    public int getFinalSendEmptyMessageFlag() {
      //CarrierConfigValuesLoader.SEND_EMPTY_MESSAGE即"send_empty_message"
        int value = mValues.getInt(CarrierConfigValuesLoader.SEND_EMPTY_MESSAGE,
                CarrierConfigValuesLoader.SEND_EMPTY_MESSAGE_DEFAULT);
        return value;
    }
```

我们在res文件夹下grep搜索"send_empty_message"找到mms_config.xml。

``` 
      <int name="send_empty_message">0</int>//改成1
```


### DialogActivity出现在最近任务，且底部布局变成Launcher
　　解决方案 ： 将该Dialog从最近任务中移除---> 在Activity的onResume状态时，过滤该DialogActivity，不添加至recentTasks<br>
　　1、按 home 或者概览键（最近任务键），退出DialogActivity
　　当前Activity不可见要经历一个onPause和一个onStop过程，我们这里选择在onStop中finish当前活动
``` Java
    @Override
    protected void onStop() {
	finish();
        super.onStop();
    }
```
　　2、过滤DialogActivity,不添加进最近任务中
   ***frameworks/base/services/core/java/com/android/server/wm/ActivityStack.java***
``` Java
       void onActivityStateChanged(ActivityRecord record, ActivityState state, String reason) {
        if (record == mResumedActivity && state != RESUMED) {
            setResumedActivity(null, reason + " - onActivityStateChanged");
        }

        if (state == RESUMED) {
         ......
		//筛选是否添加到 recentsTasks
	if(!record.getName().contains("SimDialogActivity"))
		{
            mStackSupervisor.mRecentTasks.add(record.getTaskRecord());
		}
        }
    }
```

　　
　　
